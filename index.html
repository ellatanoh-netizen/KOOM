<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KOOM | Les Graines de l'Espoir ‚Äì Droit & Justice</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; color: #0f172a; }
    .hidden-section { display: none !important; }
    .btn-pro { transition: 0.3s; cursor: pointer; border-radius: 1rem; font-weight: 800; display: flex; align-items: center; justify-content: center; }
    .card-pro { background: white; border: 1px solid #e2e8f0; border-radius: 2rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); }
    .tab-active { background: #2E7D32 !important; color: white !important; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #e2e8f0; border-radius: 1.5rem; overflow: hidden; }
    .calendar-day { background: #fff; min-height: 110px; padding: 10px; border: 0.5px solid #f1f5f9; }
    .hour-checkbox { accent-color: #2E7D32; width: 14px; height: 14px; cursor: pointer; }
  </style>
</head>
<body>

  <div id="loader" class="fixed inset-0 z-[100] bg-white flex flex-col items-center justify-center">
    <div class="w-14 h-14 border-4 border-slate-100 border-t-[#2E7D32] rounded-full animate-spin"></div>
    <p class="mt-4 text-[10px] font-black text-slate-400 uppercase tracking-widest text-center">Initialisation KOOM 2026...</p>
  </div>

  <header id="app-header" class="hidden-section sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b px-6 py-4 flex justify-between items-center">
    <div class="flex items-center gap-2 cursor-pointer" onclick="location.reload()">
      <div class="w-10 h-10 bg-[#2E7D32] text-white rounded-xl flex items-center justify-center font-black shadow-lg">K</div>
      <div class="ml-2">
        <span class="font-black text-xl tracking-tighter uppercase block leading-none">KOOM</span>
        <span class="text-[8px] font-bold text-slate-400 uppercase tracking-widest">Les Graines de l'Espoir ‚Äì Droit & Justice</span>
      </div>
    </div>
    <div id="u-info" class="hidden md:block text-[10px] font-black uppercase text-slate-400 tracking-widest">--</div>
    <button onclick="window.logout()" class="p-2 bg-rose-50 text-rose-600 rounded-lg hover:bg-rose-600 hover:text-white transition-all">‚èª</button>
  </header>

  <main class="max-w-7xl mx-auto p-6">
    <div id="alert-zone" class="hidden-section fixed top-24 left-1/2 -translate-x-1/2 z-[100] w-full max-w-sm px-4"></div>

    <section id="section-entry" class="hidden-section mt-12 text-center">
      <h1 class="text-7xl font-black mb-4 tracking-tighter text-slate-900">KOOM <span class="text-[#2E7D32]">2026</span></h1>
      <p class="text-slate-400 font-bold uppercase text-xs tracking-widest mb-12 italic">Association Les Graines de l'Espoir ‚Äì Droit & Justice</p>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        <div onclick="window.showS('section-part')" class="card-pro p-12 cursor-pointer hover:shadow-2xl hover:-translate-y-2 transition-all"><h3 class="font-black text-2xl text-[#2E7D32]">Partenaires</h3><p class="text-xs text-slate-400 mt-2 uppercase tracking-widest">Nouveau dossier</p></div>
        <div onclick="window.auth('BENE')" class="card-pro p-12 cursor-pointer text-[#2E7D32] border-[#2E7D32]/20 hover:shadow-2xl"><h3 class="font-black text-2xl">B√©n√©voles</h3><p class="text-xs text-slate-400 mt-2 uppercase tracking-widest">Dispos & Missions</p></div>
        <div onclick="window.auth('COORD')" class="card-pro p-12 cursor-pointer bg-slate-900 text-white border-none hover:shadow-2xl"><h3 class="font-black text-2xl text-white uppercase">Coordination</h3><p class="text-xs text-slate-300 mt-2 uppercase tracking-widest">Pilotage Global</p></div>
      </div>
    </section>

    <section id="section-part" class="hidden-section max-w-xl mx-auto bg-white p-12 rounded-[3.5rem] shadow-xl border">
      <h2 class="text-3xl font-black mb-8 text-[#2E7D32] tracking-tight">Nouvelle Demande</h2>
      <form id="form-part" class="space-y-4">
        <input type="text" id="p-structure" placeholder="Votre Structure" class="w-full p-4 bg-slate-50 rounded-xl border-none focus:ring-2 focus:ring-[#2E7D32]" required>
        <div class="flex gap-2">
            <input type="text" id="p-dossier" placeholder="R√©f Dossier" class="w-1/2 p-4 bg-slate-50 rounded-xl border-none" required>
            <input type="email" id="p-email" placeholder="Email contact" class="w-1/2 p-4 bg-slate-50 rounded-xl border-none" required>
        </div>
        <select id="p-quartier" class="w-full p-4 bg-slate-50 rounded-xl border-none" required>
          <option value="">-- Quel Secteur de Toulouse ? --</option>
          <option value="Secteur 1 (Centre)">Secteur 1 : Centre (Capitole, Carmes, Marengo)</option>
          <option value="Secteur 2 (Rive Gauche)">Secteur 2 : Rive Gauche (St-Cyprien, Bagatelle, Mirail)</option>
          <option value="Secteur 3 (Nord)">Secteur 3 : Nord (Minimes, Borderouge, Lalande)</option>
          <option value="Secteur 4 (Est)">Secteur 4 : Est (Bonnefoy, Roseraie, Jolimont)</option>
          <option value="Secteur 5 (Sud-Est)">Secteur 5 : Sud-Est (Rangueil, St-Michel, Empalot)</option>
          <option value="Secteur 6 (Ouest)">Secteur 6 : Ouest (Lardenne, Purpan, St-Simon)</option>
          <option value="P√©riph√©rie">P√©riph√©rie / Agglom√©ration</option>
        </select>
        <div class="flex gap-2"><input type="date" id="p-date" min="2026-01-01" class="w-1/2 p-4 bg-slate-50 rounded-xl border-none" required><input type="time" id="p-heure" class="w-1/2 p-4 bg-slate-50 rounded-xl border-none" required></div>
        <input type="text" id="p-lieu" placeholder="Lieu exact du rendez-vous" class="w-full p-4 bg-slate-50 rounded-xl border-none" required>
        <button type="submit" id="btn-part" class="btn-pro w-full py-5 bg-[#2E7D32] text-white uppercase tracking-widest mt-4">Envoyer le dossier</button>
        <button type="button" onclick="window.showS('section-entry')" class="w-full text-xs font-bold text-slate-400 mt-2 italic text-center">Retour</button>
      </form>
    </section>

    <section id="section-coord" class="hidden-section space-y-8">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="bg-white p-6 rounded-[2rem] border shadow-sm"><div class="text-[10px] font-black text-slate-400 uppercase">√Ä Valider</div><div id="stat-attente" class="text-3xl font-black text-amber-500">0</div></div>
        <div class="bg-white p-6 rounded-[2rem] border shadow-sm"><div class="text-[10px] font-black text-slate-400 uppercase">En Ligne</div><div id="stat-valide" class="text-3xl font-black text-[#2E7D32]">0</div></div>
        <div class="bg-[#2E7D32] p-6 rounded-[2rem] text-white shadow-lg"><div class="text-[10px] font-black opacity-60 uppercase">Total 2026</div><div id="stat-total" class="text-3xl font-black">0</div></div>
        <div class="bg-slate-900 p-6 rounded-[2rem] text-white shadow-lg"><div class="text-[10px] font-black opacity-60 uppercase">Pourvues</div><div id="stat-pourvu" class="text-3xl font-black">0</div></div>
      </div>

      <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-4 rounded-[2.5rem] border shadow-sm">
        <div class="flex gap-4 items-center">
            <button onclick="window.changeM(-1)" class="w-10 h-10 flex items-center justify-center bg-slate-50 rounded-full font-bold">‚Äπ</button>
            <div id="cal-label" class="font-black uppercase text-xs w-52 text-center text-slate-600 tracking-widest">--</div>
            <button onclick="window.changeM(1)" class="w-10 h-10 flex items-center justify-center bg-slate-50 rounded-full font-bold">‚Ä∫</button>
        </div>
        <div class="flex bg-slate-100 p-1.5 rounded-xl">
          <button id="c-tab-cal" onclick="window.cTab('CAL')" class="px-6 py-2 rounded-lg text-[9px] font-black tab-active transition-all">CALENDRIER</button>
          <button id="c-tab-list" onclick="window.cTab('LIST')" class="px-6 py-2 rounded-lg text-[9px] font-black transition-all">GESTION</button>
          <button id="c-tab-dispo" onclick="window.cTab('DISPO')" class="px-6 py-2 rounded-lg text-[9px] font-black transition-all">DISPOS B√âN√âS</button>
        </div>
      </div>

      <div id="view-c-cal" class="calendar-grid bg-white p-6 shadow-xl border"></div>
      <div id="view-c-list" class="hidden-section grid grid-cols-1 md:grid-cols-3 gap-6"></div>
      
      <div id="view-c-dispo" class="hidden-section bg-white p-10 rounded-[3rem] border shadow-sm space-y-4">
        <h3 class="text-xl font-black mb-4">Disponibilit√©s des B√©n√©voles</h3>
        <div id="list-dispos-benes" class="space-y-4 text-[10px] font-bold tracking-widest text-slate-500 uppercase">Chargement...</div>
      </div>
    </section>

    <section id="section-bene" class="hidden-section space-y-8">
      <div class="bg-slate-900 text-white p-8 rounded-[2.5rem] flex justify-between items-center shadow-xl">
        <div><h2 id="b-welcome" class="text-2xl font-black leading-tight">Bonjour</h2><div id="b-zone" class="text-[9px] font-black uppercase text-emerald-400 mt-1 tracking-widest">KOOM | LGE ‚Äì Droit & Justice</div></div>
        <div class="flex bg-white/10 p-1.5 rounded-xl">
          <button id="b-tab-plan" onclick="window.bTab('PLAN')" class="px-5 py-2.5 rounded-xl text-[9px] font-black tab-active">MON PLANNING</button>
          <button id="b-tab-mis" onclick="window.bTab('MIS')" class="px-5 py-2.5 rounded-xl text-[9px] font-black">MISSIONS</button>
        </div>
      </div>
      
      <div id="b-view-plan" class="card-pro p-10">
        <div class="flex justify-between items-center mb-10">
          <h3 class="font-black text-xl">Mes disponibilit√©s 2026</h3>
          <div class="flex gap-4 items-center bg-slate-100 p-2 rounded-2xl">
            <button onclick="window.changeWeek(-1)" class="w-10 h-10 bg-white rounded-xl shadow-sm font-black">‚Äπ</button>
            <div id="week-label" class="text-[10px] font-black uppercase w-48 text-center text-slate-400">--</div>
            <button onclick="window.changeWeek(1)" class="w-10 h-10 bg-white rounded-xl shadow-sm font-black">‚Ä∫</button>
          </div>
        </div>
        
        <div id="grid-dispo" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-6"></div>
        <button onclick="window.savePlanning()" id="btn-save-plan" class="btn-pro w-full py-5 bg-[#2E7D32] text-white uppercase mt-8 tracking-widest shadow-lg transition-all">Enregistrer ma semaine</button>
      </div>

      <div id="b-view-mis" class="hidden-section grid grid-cols-1 md:grid-cols-2 gap-10">
        <div><h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Mes Engagements</h3><div id="b-mine" class="space-y-4"></div></div>
        <div><h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Missions Libres</h3><div id="b-avail" class="space-y-4"></div></div>
      </div>
    </section>
  </main>

  <script>
    // VOTRE URL DE SCRIPT GOOGLE
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwQA4gWE2FCJc1KHKKR45_4MXzPlxuQl2HQOpQCxEhqqxwNMw0e2Xm9Njwjq0nD25f2-Q/exec";
    
    const DAYS_FR = ["Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi"];
    const MONTHS_FR = ["Janvier", "F√©vrier", "Mars", "Avril", "Mai", "Juin", "Juillet", "Ao√ªt", "Septembre", "Octobre", "Novembre", "D√©cembre"];
    const STATE = { token: sessionStorage.getItem('k_token'), user: null, missions: [], m: new Date().getMonth(), y: new Date().getFullYear(), curMon: getMonday(new Date()) };

    function getMonday(d) { d = new Date(d); let day = d.getDay(), diff = d.getDate() - day + (day === 0 ? -6 : 1); return new Date(d.setDate(diff)); }
    const $ = (id) => document.getElementById(id);
    const hide = (id) => $(id).classList.add('hidden-section');
    const show = (id) => $(id).classList.remove('hidden-section');

    async function api(action, data = {}, method = 'POST') {
      const url = new URL(SCRIPT_URL); if(method === 'GET') { url.searchParams.set('action', action); if(STATE.token) url.searchParams.set('token', STATE.token); const r = await fetch(url); return await r.json(); }
      const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action, token: STATE.token, token_nom: STATE.user?.nom, ...data }) }); 
      return await response.json();
    }

    // CALENDRIER COORD
    function renderCalendar() {
      const container = $('view-c-cal'); if(!container) return; 
      $('cal-label').innerText = `${MONTHS_FR[STATE.m]} ${STATE.y}`;
      const daysInMonth = new Date(STATE.y, STATE.m + 1, 0).getDate(); 
      const firstDay = (new Date(STATE.y, STATE.m, 1).getDay() + 6) % 7;
      let html = ''; 
      ['L','M','M','J','V','S','D'].forEach(d => html += `<div class="bg-slate-50 p-2 text-center text-[10px] font-black text-slate-400 uppercase">${d}</div>`);
      for (let i=0; i<firstDay; i++) html += `<div></div>`;
      for (let d=1; d<=daysInMonth; d++) {
        const dateISO = `${STATE.y}-${String(STATE.m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const dayMissions = STATE.missions.filter(m => m.dISO === dateISO);
        html += `<div class="calendar-day"><div class="text-[10px] font-black text-slate-300 mb-1">${d}</div>${dayMissions.map(m => `<div class="p-1 mb-1 text-[7px] font-black text-white rounded truncate ${m.statut==='ATTENTE'?'bg-amber-500':'bg-[#2E7D32]'}">${m.part}</div>`).join('')}</div>`;
      }
      container.innerHTML = html;
    }

    window.refreshData = async () => {
      const res = await api('GET_MISSIONS', {}, 'GET');
      if(res && res.ok) { 
        STATE.missions = res.missions.map(m => {
            let iso = m.date; if(m.date.includes('/')) iso = m.date.split('/').reverse().join('-');
            return { ...m, dISO: iso };
        });
        if(STATE.user?.role==='COORD') { updateStats(); renderCalendar(); renderCoordList(); }
        else { renderBeneList(); }
      }
      hide('loader');
    };

    function updateStats() { if(STATE.user.role !== 'COORD') return; $('stat-attente').innerText = STATE.missions.filter(m => m.statut === 'ATTENTE').length; $('stat-valide').innerText = STATE.missions.filter(m => m.statut === 'VALID√â').length; $('stat-pourvu').innerText = STATE.missions.filter(m => m.statut === 'POURVU').length; $('stat-total').innerText = STATE.missions.length; }

    function renderCoordList() {
      $('view-c-list').innerHTML = STATE.missions.map(m => `<div class="bg-white p-6 rounded-[2rem] border shadow-sm transition-all hover:border-[#2E7D32] hover:shadow-lg"><div class="flex justify-between items-center mb-3"><span class="text-[8px] font-black bg-slate-100 px-2 py-0.5 rounded uppercase text-slate-500">${m.statut}</span></div><h4 class="font-black text-lg truncate">${m.part}</h4><p class="text-[10px] font-bold text-slate-400 mt-1">${m.date} ‚Ä¢ ${m.heure}</p><div class="mt-4 flex gap-2">${m.statut === 'ATTENTE' ? `<button onclick="window.upM('${m.id}','VALID√â')" class="flex-1 py-3 bg-[#2E7D32] text-white rounded-xl text-[10px] font-black uppercase transition-all">VALIDER</button>`:''}<button onclick="window.archiveM('${m.id}')" class="p-3 bg-rose-50 text-rose-500 rounded-xl transition-all">üóë</button></div></div>`).join('');
    }

    // PLANNING HEURES COCHABLES
    window.renderBenePlanning = () => {
      const start = new Date(STATE.curMon); $('week-label').innerText = `Semaine du ${start.getDate()}/${start.getMonth()+1}`;
      let html = ''; 
      for(let i=0; i<6; i++) { 
        let cur = new Date(start); cur.setDate(start.getDate()+i); 
        let hoursHtml = '<div class="grid grid-cols-2 gap-1 mt-3">';
        for(let h=8; h<=20; h++) {
          let time = h < 10 ? '0'+h+':00' : h+':00';
          hoursHtml += `<label class="flex items-center gap-2 p-1 bg-white rounded border border-slate-100 hover:bg-emerald-50 cursor-pointer"><input type="checkbox" class="hour-checkbox day-${i}" value="${time}"><span class="text-[9px] font-bold text-slate-600">${time}</span></label>`;
        }
        hoursHtml += '</div>';
        html += `<div class="p-4 bg-slate-50 rounded-3xl border border-slate-100 shadow-sm"><div class="text-[10px] font-black uppercase text-[#2E7D32] mb-1">${DAYS_FR[i]} ${cur.getDate()}</div>${hoursHtml}</div>`; 
      } 
      $('grid-dispo').innerHTML = html;
    };

    window.savePlanning = async () => {
      let jrs = []; 
      for(let i=0; i<6; i++) { 
        const checked = Array.from(document.querySelectorAll(`.day-${i}:checked`));
        jrs.push(checked.map(cb => cb.value).join(', ') || "INDISPO");
      } 
      await api('UPDATE_PLANNING', { jours: jrs });
      alert("Disponibilit√©s enregistr√©es !");
    };

    function renderBeneList() {
      const libres = STATE.missions.filter(m => m.statut === 'VALID√â');
      $('b-avail').innerHTML = libres.map(m => `<div class="bg-white p-6 rounded-[2.5rem] border shadow-sm transition-all hover:shadow-lg"><h4 class="font-black text-lg mt-3">${m.part}</h4><p class="text-xs text-slate-400 mt-1 font-bold">üìç ${m.quartier}</p><button onclick="window.takeM('${m.id}','${m.code}')" class="w-full py-5 bg-[#2E7D32] text-white rounded-2xl text-[10px] font-black mt-6 uppercase transition-all">S'engager</button></div>`).join('') || '<div class="text-slate-400 text-xs italic p-10 text-center">Plus de missions libres</div>';
    }

    window.cTab = async (t) => {
      ['view-c-cal','view-c-list','view-c-dispo'].forEach(hide); ['c-tab-cal','c-tab-list','c-tab-dispo'].forEach(id => $(id).classList.remove('tab-active'));
      show('view-c-'+t.toLowerCase()); $(`c-tab-${t.toLowerCase()}`).classList.add('tab-active');
    };

    window.bTab = (t) => { ['b-view-plan','b-view-mis'].forEach(hide); ['b-tab-plan','b-tab-mis'].forEach(id => $(id).classList.remove('tab-active')); show('b-view-'+t.toLowerCase()); $(`b-tab-${t.toLowerCase()}`).classList.add('tab-active'); if(t==='PLAN') window.renderBenePlanning(); else window.renderBeneList(); };
    window.changeM = (dir) => { STATE.m += dir; if(STATE.m<0){STATE.m=11; STATE.y--;} if(STATE.m>11){STATE.m=0; STATE.y++;} renderCalendar(); };
    window.showS = (id) => { ['section-entry','section-part','section-coord','section-bene'].forEach(hide); show(id); };
    window.takeM = async (id, code) => { if(!confirm("S'engager ?")) return; await api('BENE_ACCEPTE', { idMission: id, code, token_nom: STATE.user.nom }); location.
