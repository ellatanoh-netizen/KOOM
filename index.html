<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KOOM | LGE – Droit & Justice</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; color: #0f172a; }
    .hidden-section { display: none !important; }
    .btn-pro { transition: 0.3s; cursor: pointer; border-radius: 1rem; font-weight: 800; display: flex; align-items: center; justify-content: center; }
    .card-pro { background: white; border: 1px solid #e2e8f0; border-radius: 2rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); }
    .tab-active { background: #2E7D32 !important; color: white !important; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #e2e8f0; border-radius: 1.5rem; overflow: hidden; }
    .calendar-day { background: #fff; min-height: 110px; padding: 10px; border: 0.5px solid #f1f5f9; }
    .hour-checkbox { accent-color: #2E7D32; width: 14px; height: 14px; cursor: pointer; }
  </style>
</head>
<body>

  <div id="loader" class="fixed inset-0 z-[100] bg-white flex flex-col items-center justify-center">
    <div class="w-14 h-14 border-4 border-slate-100 border-t-[#2E7D32] rounded-full animate-spin"></div>
    <p class="mt-4 text-[10px] font-black text-slate-400 uppercase tracking-widest text-center">Initialisation KOOM...</p>
  </div>

  <header id="app-header" class="hidden-section sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b px-6 py-4 flex justify-between items-center">
    <div class="flex items-center gap-2 cursor-pointer" onclick="location.reload()">
      <div class="w-10 h-10 bg-[#2E7D32] text-white rounded-xl flex items-center justify-center font-black shadow-lg">K</div>
      <div class="ml-2">
        <span class="font-black text-xl tracking-tighter uppercase block leading-none">KOOM</span>
        <span class="text-[8px] font-bold text-slate-400 uppercase tracking-widest">Les Graines de l'Espoir – Droit & Justice</span>
      </div>
    </div>
    <div id="u-info" class="hidden md:block text-[10px] font-black uppercase text-slate-400 tracking-widest">--</div>
    <button onclick="window.logout()" class="p-2 bg-rose-50 text-rose-600 rounded-lg hover:bg-rose-600 hover:text-white transition-all">⏻</button>
  </header>

  <main class="max-w-7xl mx-auto p-6">
    <div id="alert-zone" class="hidden-section fixed top-24 left-1/2 -translate-x-1/2 z-[100] w-full max-w-sm px-4"></div>

    <section id="section-entry" class="hidden-section mt-12 text-center">
      <h1 class="text-7xl font-black mb-4 tracking-tighter text-[#2E7D32]">KOOM</h1>
      <p class="text-slate-400 font-bold uppercase text-xs tracking-widest mb-12 italic">Association Les Graines de l'Espoir – Droit & Justice</p>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        <div onclick="window.showS('section-part')" class="card-pro p-12 cursor-pointer hover:shadow-2xl"><h3>Partenaires</h3></div>
        <div onclick="window.auth('BENE')" class="card-pro p-12 cursor-pointer border-[#2E7D32]/20 hover:shadow-2xl text-[#2E7D32]"><h3>Bénévoles</h3></div>
        <div onclick="window.auth('COORD')" class="card-pro p-12 cursor-pointer bg-slate-900 text-white border-none"><h3>Coordination</h3></div>
      </div>
    </section>

    <section id="section-part" class="hidden-section max-w-xl mx-auto bg-white p-12 rounded-[3.5rem] shadow-xl border">
      <h2 class="text-3xl font-black mb-8 text-[#2E7D32]">Nouvelle Demande</h2>
      <form id="form-part" class="space-y-4">
        <input type="text" id="p-structure" placeholder="Votre Structure" class="w-full p-4 bg-slate-50 rounded-xl" required>
        <select id="p-quartier" class="w-full p-4 bg-slate-50 rounded-xl" required>
          <option value="">-- Quel Secteur de Toulouse ? --</option>
          <option value="Secteur 1 (Centre)">Secteur 1 : Centre (Capitole, Carmes, Marengo)</option>
          <option value="Secteur 2 (Rive Gauche)">Secteur 2 : Rive Gauche (St-Cyprien, Bagatelle, Mirail)</option>
          <option value="Secteur 3 (Nord)">Secteur 3 : Nord (Minimes, Borderouge, Lalande)</option>
          <option value="Secteur 4 (Est)">Secteur 4 : Est (Bonnefoy, Roseraie, Jolimont)</option>
          <option value="Secteur 5 (Sud-Est)">Secteur 5 : Sud-Est (Rangueil, St-Michel, Empalot)</option>
          <option value="Secteur 6 (Ouest)">Secteur 6 : Ouest (Lardenne, Purpan, St-Simon)</option>
          <option value="Périphérie">Périphérie / Agglomération</option>
        </select>
        <div class="flex gap-2"><input type="date" id="p-date" class="w-1/2 p-4 bg-slate-50 rounded-xl" required><input type="time" id="p-heure" class="w-1/2 p-4 bg-slate-50 rounded-xl" required></div>
        <input type="text" id="p-lieu" placeholder="Lieu exact" class="w-full p-4 bg-slate-50 rounded-xl" required>
        <button type="submit" class="btn-pro w-full py-5 bg-[#2E7D32] text-white">ENVOYER</button>
      </form>
    </section>

    <section id="section-coord" class="hidden-section space-y-8">
        <div id="view-c-cal" class="calendar-grid bg-white p-6 shadow-xl border"></div>
    </section>

    <section id="section-bene" class="hidden-section space-y-8">
      <div id="b-view-plan" class="card-pro p-10">
        <h3 class="font-black text-xl mb-10 text-slate-700">Mes disponibilités</h3>
        <div id="grid-dispo" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-6"></div>
        <button onclick="window.savePlanning()" id="btn-save-plan" class="btn-pro w-full py-5 bg-[#2E7D32] text-white uppercase mt-8">Enregistrer</button>
      </div>
    </section>
  </main>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwQA4gWE2FCJc1KHKKR45_4MXzPlxuQl2HQOpQCxEhqqxwNMw0e2Xm9Njwjq0nD25f2-Q/exec";
    const DAYS_FR = ["Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi"];
    const STATE = { token: sessionStorage.getItem('k_token'), user: null };

    const $ = (id) => document.getElementById(id);
    const hide = (id) => $(id).classList.add('hidden-section');
    const show = (id) => $(id).classList.remove('hidden-section');

    async function api(action, data = {}, method = 'POST') {
      try {
        const url = new URL(SCRIPT_URL); 
        if(method === 'GET') { 
          url.searchParams.set('action', action); 
          if(STATE.token) url.searchParams.set('token', STATE.token); 
          const r = await fetch(url); return await r.json(); 
        }
        const r = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action, token: STATE.token, ...data }) }); 
        return await r.json();
      } catch (e) { console.error(e); return { ok: false }; }
    }

    window.renderBenePlanning = () => {
      let html = ''; 
      for(let i=0; i<6; i++) { 
        let hoursHtml = '<div class="grid grid-cols-2 gap-1 mt-3">';
        for(let h=8; h<=20; h++) {
          let t = h < 10 ? '0'+h+':00' : h+':00';
          hoursHtml += `<label class="flex items-center gap-2 p-1 bg-white rounded border cursor-pointer"><input type="checkbox" class="hour-checkbox day-${i}" value="${t}"><span class="text-[9px] font-bold text-slate-500">${t}</span></label>`;
        }
        html += `<div class="p-4 bg-slate-50 rounded-3xl border shadow-sm"><div class="text-[10px] font-black uppercase text-[#2E7D32] mb-1">${DAYS_FR[i]}</div>${hoursHtml.concat('</div>')}</div>`; 
      } 
      $('grid-dispo').innerHTML = html;
    };

    window.savePlanning = async () => {
      let jrs = []; for(let i=0; i<6; i++) { const checked = Array.from(document.querySelectorAll(`.day-${i}:checked`)); jrs.push(checked.map(cb => cb.value).join(', ') || "INDISPO"); } 
      await api('UPDATE_PLANNING', { jours: jrs }); alert("Enregistré !");
    };

    window.auth = () => { const t = prompt("Code :"); if(t){ sessionStorage.setItem('k_token', t.trim()); location.reload(); } };
    window.showS = (id) => { ['section-entry','section-part','section-coord','section-bene'].forEach(hide); show(id); };
    window.logout = () => { sessionStorage.clear(); location.reload(); };

    async function init() {
      if(STATE.token) {
        const res = await api('AUTH_TOKEN', {}, 'GET');
        hide('loader');
        if(res && res.ok) { 
            STATE.user = res; show('app-header'); $('u-info').innerText = `${res.nom}`; 
            if(res.role === 'COORD') window.showS('section-coord');
            else { window.showS('section-bene'); window.renderBenePlanning(); } 
        } else { sessionStorage.clear(); window.showS('section-entry'); }
      } else { hide('loader'); window.showS('section-entry'); }
    }
    init();
  </script>
</body>
</html>
