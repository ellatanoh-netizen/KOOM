<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KOOM | Les Graines de l'Espoir – Droit & Justice</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      background: #f8fafc;
      color: #0f172a;
      overflow-x: hidden;
    }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { scrollbar-width: none; -ms-overflow-style: none; }
    .animate-in { animation: fadeUp .25s ease both; }
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background-color: #f1f5f9;
    }
  </style>
</head>

<body class="min-h-screen bg-slate-50 text-slate-900 selection:bg-emerald-100 text-[12px]">
  <div id="app"></div>

  <script>
const API_URL = "https://script.google.com/macros/s/AKfycbzZyTFTBEFKx4RX7qQObKGiZmmbgPB9NT_7ZQjJUh3AhXGoSGDU_2dtZZeacIUjT9zMFQ/exec";
const CR_FORM_BASE = "https://docs.google.com/forms/d/e/1FAIpQLSdUtRDVw9x2rKQ7qLNikLqoajvHhcnd6aCNF87hLqn_oBwcZw/viewform?usp=pp_url&entry.1178799885=";
const LOGO_URL = "https://lgedroitetjustice.fr/wp-content/uploads/2025/05/cropped-cropped-LOGO-2-282x300.png";
const TIMEOUT_BYPASS = 4000;

const ASSO_NAME = "Les Graines de l'Espoir - Droit et justice";

const SECTEURS = [
  { value: "Centre", label: "Centre (Secteur 1 – Capitole, Arnaud-Bernard, Carmes, Saint-Étienne, Compans-Caffarelli, Chalets)" },
  { value: "Rive Gauche", label: "Rive Gauche (Secteur 2 – Saint-Cyprien, Patte d’Oie, Croix-de-Pierre, Fontaine-Lestang, Cartoucherie)" },
  { value: "Nord", label: "Nord (Secteur 3 – Minimes, Barrière de Paris, Lalande, Sept-Deniers, Ginestous)" },
  { value: "Est", label: "Est (Secteur 4 – Bonnefoy, Jolimont, Roseraie, Soupetard, Marengo)" },
  { value: "Sud / Sud-Est", label: "Sud / Sud-Est (Secteur 5 – Rangueil, Saouzelong, Jules-Julien, Saint-Michel, Empalot, Île du Ramier)" },
  { value: "Ouest", label: "Ouest (Secteur 6 – Lardenne, Purpan, Saint-Martin-du-Touch, Ancely, Casselardit)" },
  { value: "Périphérie", label: "Périphérie (hors Toulouse intra-muros)" },
  { value: "Toutes les zones", label: "Toutes les zones" }
];

const MISSION_TYPES = ["Commissariat", "Avocat", "Tribunal", "Social", "Autre"];

const state = {
  view: "hub",
  loading: true,
  error: null,

  user: null,
  authRole: null,
  isAuthModalOpen: false,

  missions: [],
  selectedSlots: new Set(),
  selectedMission: null,
  coordTab: "journal",

  uiKey: 0,
  volunteerCurrentDate: new Date(2026, 0, 1),
  calendarBaseDate: new Date(2026, 0, 1),
  coordWeekDate: new Date(2026, 0, 1),

  partnerSubmitted: false,

  systemLogs: [
    { time: "08:00:01", event: "Trigger Automatique : Nettoyage", status: "SUCCESS", type: "system" },
    { time: "08:00:05", event: "Test : Intégrité API", status: "OK", type: "test" },
    { time: "09:00:00", event: "Mail : Rappel J-1 envoyé", status: "SENT", type: "mail" },
    { time: "10:00:00", event: "Test : Latence Cloud", status: "240ms", type: "test" }
  ],

  availabilityMatrix: {},
  availabilityLastSync: null,
  coordPollingTimer: null
};

const $app = document.getElementById("app");

function escapeHtml(str = "") {
  return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
}

function upperTrim(val) { return String(val ?? "").trim().toUpperCase(); }

function normalizeMission(m) {
  const mm = { ...m };
  mm.code = m["Code mission"] || m.CODE || m.code || m.id;
  mm.structure = m.Partenaire || m.PARTENAIRE || m.structure;
  mm.date = m.Date_RDV || m.DATE || m.date;
  mm.heure = m.Heure_RDV || m.HEURE || m.heure;
  mm.secteur = m["Quartier "] || m.Quartier || m.secteur;
  mm.statut = upperTrim(m.Statut || m.STATUT || m.statut || "");
  mm.lieu = m.Lieu_RDV || m.LIEU || m.lieu;
  mm.volunteerName = m.Benevole_ID || m.BENEVOLE || m.volunteerName || m.beneNom || "";
  mm.phone = m.phone || m.Téléphone || "";
  mm.refDossier = m.refDossier || m.Référence || "";
  mm.commentaires = m.commentaires || m.Commentaires || "";
  return mm;
}

async function fetchWithRetry(url, options = {}, retries = 2, backoff = 1000) {
  try {
    const response = await fetch(url, { ...options, mode: "cors", redirect: "follow" });
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    const text = await response.text();
    try { return JSON.parse(text); } catch { return { ok: false, error: "JSON Invalide" }; }
  } catch (err) {
    if (retries > 0) {
      await new Promise(r => setTimeout(r, backoff));
      return fetchWithRetry(url, options, retries - 1, backoff * 1.5);
    }
    throw err;
  }
}

function getWeekRange(date) {
  const curr = new Date(date);
  const day = curr.getDay();
  const diff = curr.getDate() - day + (day === 0 ? -6 : 1);
  const monday = new Date(new Date(curr).setDate(diff));
  monday.setHours(0, 0, 0, 0);
  const saturday = new Date(new Date(monday).setDate(monday.getDate() + 5));
  return { start: monday, end: saturday };
}

function goTo(nextView) {
  state.error = null;
  state.isAuthModalOpen = false;
  state.selectedMission = null;
  if (nextView !== "coord") state.coordTab = "journal";
  if (nextView !== "volunteer") state.selectedSlots = new Set();
  state.view = nextView;
  if (nextView === "coord") startCoordPolling(); else stopCoordPolling();
  state.uiKey++;
  render();
}

function pad2(n){ return String(n).padStart(2,"0"); }
function toISODate(d){ const x = new Date(d); return `${x.getFullYear()}-${pad2(x.getMonth()+1)}-${pad2(x.getDate())}`; }
function formatFR(d){ return new Date(d).toLocaleDateString("fr-FR", { day:"2-digit", month:"2-digit", year:"numeric" }); }

function LoaderHTML() {
  return `
    <div class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white/95 backdrop-blur-md">
      <div class="relative flex items-center justify-center">
        <div class="w-12 h-12 border-4 border-emerald-100 border-t-emerald-600 rounded-full animate-spin"></div>
        <img src="${LOGO_URL}" class="absolute w-6 h-6 object-contain" alt="Logo">
      </div>
      <p class="mt-4 text-slate-500 font-bold text-[9px] uppercase tracking-widest">KOOM Synchronization...</p>
    </div>
  `;
}

function NavbarHTML() {
  const user = state.user;
  return `
    <nav class="sticky top-0 z-50 bg-white/95 backdrop-blur-md border-b border-emerald-100 px-5 py-2.5 flex justify-between items-center h-14 shadow-sm">
      <div class="flex items-center gap-3 cursor-pointer" id="navHome">
        <img src="${LOGO_URL}" class="w-8 h-8 object-contain" alt="Logo Association">
        <div class="flex flex-col text-left">
          <h1 class="text-sm font-black tracking-tighter leading-none">KOOM</h1>
          <p class="text-[6px] text-emerald-600 uppercase font-black tracking-widest">${escapeHtml(ASSO_NAME)}</p>
        </div>
      </div>
      ${user ? `
        <div class="flex items-center gap-4">
          <div class="text-right leading-none">
            <p class="text-[10px] font-black text-slate-900 uppercase">${escapeHtml(user.name)}</p>
            <p class="text-[8px] text-emerald-600 font-black uppercase tracking-widest">${state.authRole === "BENE" ? "BÉNÉVOLE" : "COORDINATION"}</p>
          </div>
          <button id="btnLogout" class="p-2 bg-slate-50 text-slate-400 rounded-lg hover:text-red-600 transition-all">
            <i data-lucide="log-out" style="width:16px;height:16px;"></i>
          </button>
        </div>
      ` : `<div class="text-[8px] font-black text-slate-400 uppercase tracking-widest opacity-40">v4.8 Stable • 2026</div>`}
    </nav>
  `;
}

function FooterHTML() {
  return `<footer class="mt-12 py-8 border-t border-slate-200 text-center bg-white/50"><p class="text-[9px] font-black text-slate-400 uppercase tracking-[0.2em]">${escapeHtml(ASSO_NAME)}</p><p class="text-[8px] text-slate-300 mt-2 font-bold uppercase tracking-wider">KOOM System • Version Stable v4.8 • 2026</p></footer>`;
}

function HubCardHTML({ icon, title, label, isDark, color, action }) {
  return `
    <div data-hub-action="${escapeHtml(action)}"
      class="${isDark ? "bg-slate-900 text-white" : "bg-white text-slate-900 border border-slate-100"} p-8 rounded-[2rem] shadow-xl cursor-pointer hover:-translate-y-2 transition-all">
      <div class="w-12 h-12 rounded-2xl flex items-center justify-center mb-6 mx-auto ${isDark ? "bg-white/10" : escapeHtml(color)}">
        <i data-lucide="${escapeHtml(icon)}" style="width:24px;height:24px;"></i>
      </div>
      <h3 class="text-xl font-black uppercase mb-2">${escapeHtml(title)}</h3>
      <p class="${isDark ? "text-white/40" : "text-slate-400"} text-[9px] font-black uppercase tracking-widest">${escapeHtml(label)}</p>
    </div>
  `;
}

function HubHTML() {
  return `
    <div class="py-6 text-center animate-in">
      <h1 class="text-6xl font-black text-slate-900 mb-2 tracking-tighter uppercase">KOOM</h1>
      <p class="text-slate-400 font-bold uppercase tracking-widest text-[9px] mb-12">Gestion automatisée des missions terrain</p>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        ${HubCardHTML({ icon: "plus-circle", title: "Partenaires", label: "Dépôt Mission", action: "partner", color: "bg-blue-50 text-blue-600", isDark: false })}
        ${HubCardHTML({ icon: "users", title: "Bénévoles", label: "Planning", action: "auth", color: "bg-emerald-50 text-emerald-600", isDark: false })}
        ${HubCardHTML({ icon: "shield-check", title: "Coordination", label: "Pilotage", action: "auth", color: "bg-slate-900 text-white", isDark: true })}
      </div>
      ${state.error ? `<div class="mt-8 max-w-xl mx-auto bg-amber-50 border border-amber-200 text-amber-800 p-4 rounded-2xl text-[10px] font-black uppercase tracking-widest">${escapeHtml(state.error)}</div>` : ``}
    </div>
  `;
}

function AuthModalHTML() {
  if (!state.isAuthModalOpen) return ``;
  return `<div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm"><div class="bg-white w-full max-w-sm p-10 rounded-[2.5rem] shadow-2xl text-center animate-in"><h3 class="text-xl font-black mb-6 uppercase">Identification</h3><form id="authForm" class="space-y-4"><input id="tokenInput" type="password" required autofocus placeholder="••••" class="w-full p-4 rounded-2xl bg-slate-50 border-2 border-slate-100 text-center font-mono text-xl focus:border-emerald-600 outline-none" /><button id="btnAuthSubmit" ${state.loading ? "disabled" : ""} type="submit" class="w-full bg-emerald-600 text-white py-4 rounded-2xl font-black uppercase tracking-widest hover:bg-slate-900 transition-all text-xs">${state.loading ? "..." : "Valider"}</button><button id="btnAuthCancel" type="button" class="text-slate-400 text-[10px] font-bold uppercase">Annuler</button></form></div></div>`;
}

function FieldHTML({ label, name, type = "text", required = false, pattern, placeholder, value = "" }) {
  const req = required ? "required" : "";
  const pat = pattern ? `pattern="${escapeHtml(pattern)}"` : "";
  const ph = placeholder ? `placeholder="${escapeHtml(placeholder)}"` : "";
  return `<div class="w-full flex flex-col gap-1.5 text-left"><label class="text-[9px] font-black uppercase text-slate-400 ml-2 tracking-widest leading-none">${escapeHtml(label)}</label><input name="${escapeHtml(name)}" type="${escapeHtml(type)}" ${req} ${pat} ${ph} value="${escapeHtml(value)}" class="w-full px-5 py-3.5 bg-slate-50 border-2 border-slate-100 rounded-2xl focus:border-emerald-600 outline-none font-bold shadow-inner text-slate-900 text-[11px] placeholder:text-slate-300 transition-all" /></div>`;
}

function DropdownHTML({ label, name, options, required = false }) {
  const req = required ? "required" : "";
  const opts = options.map(o => `<option value="${escapeHtml(o.id ?? o.value ?? o)}">${escapeHtml(o.label ?? o)}</option>`).join("");
  return `<div class="w-full flex flex-col gap-1.5 text-left"><label class="text-[9px] font-black uppercase text-slate-400 ml-2 tracking-widest leading-none">${escapeHtml(label)}</label><div class="relative"><select name="${escapeHtml(name)}" ${req} class="w-full px-5 py-3.5 bg-slate-50 border-2 border-slate-100 rounded-2xl focus:border-emerald-600 outline-none font-bold appearance-none cursor-pointer text-slate-900 text-[11px] shadow-inner transition-all"><option value="" disabled selected>Sélectionner...</option>${opts}</select><div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400"><i data-lucide="chevron-right" style="width:14px;height:14px;" class="rotate-90"></i></div></div></div>`;
}

function PartnerModuleHTML() {
  if (state.partnerSubmitted) return `<div class="text-center py-20 animate-in"><div class="w-20 h-20 bg-emerald-100 text-emerald-600 rounded-[2rem] flex items-center justify-center mx-auto mb-6 shadow-xl shadow-emerald-100/50"><i data-lucide="check-circle" style="width:40px;height:40px;"></i></div><h2 class="text-2xl font-black uppercase tracking-tighter">Dossier Transmis</h2><p class="text-slate-400 font-bold text-[10px] uppercase mt-2 mb-8 tracking-widest">Un accusé de réception vous a été envoyé</p><button id="btnPartnerBackHub" class="px-10 py-4 bg-slate-900 text-white rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-xl">Retour Hub</button></div>`;
  return `<div class="max-w-3xl mx-auto animate-in text-left"><button id="btnBackHubFromPartner" class="mb-6 text-[10px] font-black uppercase text-slate-400 flex items-center gap-2 hover:text-emerald-600 transition-colors"><i data-lucide="chevron-left" style="width:14px;height:14px;"></i> Retour Hub</button><div class="bg-white p-10 md:p-14 rounded-[3rem] shadow-2xl border border-slate-100"><h2 class="text-4xl font-black mb-10 text-slate-900 tracking-tighter uppercase underline decoration-emerald-500 decoration-4 underline-offset-8">Nouvelle Mission</h2><form id="partnerForm" class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="md:col-span-2">${FieldHTML({ label: "Structure / Organisme Nom Complet *", name: "structure", required: true })}</div>${FieldHTML({ label: "Référence dossier interne *", name: "refDossier", required: true })}${FieldHTML({ label: "Email de contact (Accusé) *", name: "emailContact", type: "email", required: true })}${FieldHTML({ label: "Numéro de téléphone direct *", name: "phone", type: "tel", required: true, pattern: "[0-9]{10}", placeholder: "0600000000" })}${DropdownHTML({ label: "Type de mission *", name: "typeMission", options: MISSION_TYPES, required: true })}<div class="md:col-span-2">${DropdownHTML({ label: "Secteur de Toulouse (Obligatoire) *", name: "secteur", options: SECTEURS.map(s => ({ id: s.value, label: s.label })), required: true })}</div>${FieldHTML({ label: "Date du rendez-vous *", name: "date", type: "date", required: true })}${FieldHTML({ label: "Heure du rendez-vous *", name: "heure", type: "time", required: true })}<div class="md:col-span-2">${FieldHTML({ label: "Lieu exact (Adresse complète) *", name: "lieu", required: true })}</div><div class="md:col-span-2"><label class="block text-[10px] font-black uppercase text-slate-400 mb-2 ml-2 tracking-widest">Commentaires / Précisions</label><textarea name="commentaires" class="w-full px-5 py-4 bg-slate-50 border-2 border-slate-100 rounded-2xl focus:border-emerald-600 outline-none font-bold text-slate-900 h-24 resize-none shadow-inner" placeholder="Ex: Besoin traducteur, étage, code d'entrée..."></textarea></div><div class="md:col-span-2 py-4"><button type="submit" class="w-full py-5 bg-emerald-600 text-white rounded-2xl font-black uppercase tracking-[0.2em] shadow-2xl hover:bg-emerald-700 transition-all text-sm">Transmettre le dossier</button></div></form></div></div>`;
}

function VolunteerDashboardHTML() {
  const user = state.user;
  const range = getWeekRange(state.volunteerCurrentDate);
  const rangeLabel = `DU ${formatFR(range.start)} AU ${formatFR(range.end)}`;
  const days = ["Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi"];
  const activeCount = state.missions.filter(m => m.volunteerName === user.name && !upperTrim(m.statut).startsWith("ARCHIV")).length;
  
  const planningRows = Array.from({ length: 12 }).map((_, hIdx) => {
    const h = `${pad2(8 + hIdx)}:00`;
    return `<tr class="border-t border-slate-50"><td class="p-2 font-black text-slate-300">${h}</td>${days.map(d => {
      const k = `${range.start.toDateString()}-${d}-${h}`;
      return `<td class="p-0.5"><div data-slot-key="${k}" class="h-7 rounded-lg cursor-pointer border transition-all ${state.selectedSlots.has(k) ? "bg-emerald-600 border-emerald-600 shadow-inner" : "bg-slate-50 border-transparent hover:border-emerald-200"}"></div></td>`;
    }).join("")}</tr>`;
  }).join("");

  const sectorOpts = SECTEURS.map(s => `<option value="${s.value}" ${user.secteur === s.value ? "selected" : ""}>${s.label}</option>`).join("");

  return `<div class="space-y-4 animate-in text-left">
    <div class="bg-emerald-600 p-5 rounded-[1.5rem] text-white shadow-lg flex justify-between items-center overflow-hidden">
      <div class="relative z-10 text-left">
        <h2 class="text-lg font-black uppercase leading-tight">Bonjour, ${escapeHtml(user.name)}</h2>
        <p class="opacity-80 font-bold text-[8px] tracking-[0.2em] uppercase mt-0.5">${escapeHtml(user.secteur)}</p>
      </div>
      <div class="relative z-10 bg-white/10 backdrop-blur-md px-4 py-2 rounded-xl text-center border border-white/20 min-w-[80px]">
        <p class="text-[7px] font-black uppercase opacity-60">Actives</p>
        <p class="text-xl font-black leading-none">${activeCount}</p>
      </div>
    </div>

    <!-- SÉLECTION DE ZONE BÉNÉVOLE -->
    <div class="bg-white p-4 rounded-xl border border-emerald-50 shadow-sm text-left">
      <label class="text-[9px] font-black uppercase text-slate-400 ml-1 tracking-widest block mb-1">Ma zone d'intervention active</label>
      <select id="volunteerSecteurSelect" class="w-full p-3 bg-slate-50 border border-slate-100 rounded-xl font-bold text-[10px] outline-none uppercase focus:ring-2 focus:ring-emerald-500/20">
        ${sectorOpts}
      </select>
    </div>

    <div class="bg-white p-5 rounded-[1.5rem] shadow-xl border border-emerald-50 text-left">
      <div class="flex justify-between items-center mb-5">
        <div>
          <h3 class="text-xs font-black uppercase tracking-widest text-emerald-900 leading-none">Planning Hebdomadaire</h3>
          <div class="inline-flex items-center gap-2 bg-emerald-50 text-emerald-700 px-3 py-1 rounded-xl w-fit mt-2 text-[9px] font-black uppercase tracking-widest">${rangeLabel}</div>
          <div class="flex gap-2 mt-2"><button id="btnWeekPrev" class="px-3 py-2 border rounded-lg text-xs font-bold">←</button><button id="btnWeekNext" class="px-3 py-2 border rounded-lg text-xs font-bold">→</button></div>
        </div>
        <button id="btnSavePlanning" class="px-5 py-2 bg-emerald-600 text-white rounded-xl font-black text-[9px] uppercase tracking-widest shadow-lg flex items-center gap-2">
          <i data-lucide="save" style="width:14px;height:14px;"></i> Enregistrer
        </button>
      </div>
      <div class="overflow-x-auto no-scrollbar">
        <table class="w-full text-center text-[9px]">
          <thead><tr><th class="p-2"></th>${days.map(d => `<th class="p-2 text-slate-400 font-black uppercase tracking-widest">${d.slice(0,3)}</th>`).join("")}</tr></thead>
          <tbody>${planningRows}</tbody>
        </table>
      </div>
    </div>

    <h3 class="text-[10px] font-black uppercase tracking-widest text-slate-400 ml-2 mt-8">Dossiers Disponibles</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      ${state.missions.filter(m => m.statut === "VALIDÉ" && !m.volunteerName).map(m => `
        <div class="bg-white p-5 rounded-[1.8rem] shadow-md border-l-[10px] border-emerald-600 text-left">
          <div class="flex justify-between items-start mb-3">
            <span class="text-[7px] font-black uppercase tracking-widest px-2.5 py-1 rounded-md bg-emerald-50 text-emerald-600">${escapeHtml(m.statut)}</span>
            <span class="text-[9px] font-black text-slate-400">${escapeHtml(m.heure)}</span>
          </div>
          <h4 class="text-md font-black mb-1 uppercase tracking-tighter leading-tight">${escapeHtml(m.structure)}</h4>
          <p class="text-emerald-600 font-black text-[8px] mb-4 uppercase tracking-widest">${escapeHtml(m.typeMission)} • ${escapeHtml(m.secteur)}</p>
          <button data-take-mission="${escapeHtml(m.code)}" class="w-full py-3 bg-slate-900 text-white rounded-2xl font-black text-[10px] uppercase tracking-[0.2em] shadow-lg hover:bg-emerald-700 transition-all">M'ENGAGER</button>
        </div>`).join("")}
    </div>
  </div>`;
}

function CoordMonthCalendarHTML() {
  const d = state.calendarBaseDate;
  const monthName = d.toLocaleDateString("fr-FR", { month: "long", year: "numeric" }).toUpperCase();
  const startingDay = (new Date(d.getFullYear(), d.getMonth(), 1).getDay() + 6) % 7;
  const daysInMonth = new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate();
  const cells = [];
  for (let i = 0; i < startingDay; i++) cells.push(`<div class="bg-white/40 min-h-[90px]"></div>`);
  for (let day = 1; day <= daysInMonth; day++) {
    const missionsDay = state.missions.filter(m => {
      const md = new Date(m.date);
      return md.getDate() === day && md.getMonth() === d.getMonth() && md.getFullYear() === d.getFullYear();
    });
    const badges = missionsDay.map(m => `<div class="bg-emerald-600 text-white text-[6px] p-1 rounded font-bold uppercase truncate mb-0.5" title="${m.structure}">${m.heure} ${m.structure}</div>`).join("");
    cells.push(`<div class="bg-white min-h-[90px] p-2 border-t border-l border-slate-100 hover:bg-slate-50 transition-colors group"><span class="text-[10px] font-black text-slate-200 group-hover:text-emerald-500">${day}</span><div class="mt-1">${badges}</div></div>`);
  }
  return `<div class="bg-white rounded-[2.5rem] shadow-2xl overflow-hidden animate-in text-left"><div class="p-6 bg-slate-50 flex justify-between items-center border-b border-slate-100"><h3 class="text-xl font-black uppercase tracking-tighter">${monthName}</h3><div class="flex gap-2"><button id="btnCalPrev" class="p-2 bg-white rounded-xl shadow-sm border border-slate-100"><i data-lucide="chevron-left" style="width:16px;height:16px;"></i></button><button id="btnCalNext" class="p-2 bg-white rounded-xl shadow-sm border border-slate-100"><i data-lucide="chevron-right" style="width:16px;height:16px;"></i></button></div></div><div class="calendar-grid">${["Lun", "Mar", "Mer", "Jeu", "Ven", "Sam", "Dim"].map(h => `<div class="bg-slate-50 p-3 text-center text-[8px] font-black text-slate-400 uppercase tracking-widest">${h}</div>`).join("")}${cells.join("")}</div></div>`;
}

function CoordVolunteerWeekHTML() {
  const range = getWeekRange(state.coordWeekDate);
  const label = `SEMAINE DU ${formatFR(range.start)} AU ${formatFR(range.end)}`;
  const days = ["Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi"];
  const hours = Array.from({ length: 12 }).map((_, i) => `${pad2(8 + i)}:00`);
  return `<div class="bg-white rounded-[2.5rem] shadow-2xl overflow-hidden animate-in text-left"><div class="p-6 bg-slate-900 text-white flex justify-between items-center"><div><h3 class="text-xl font-black uppercase tracking-tighter leading-none mb-1">Planning Disponibilités</h3><p class="text-[8px] font-black opacity-60 uppercase tracking-widest">${label}</p></div><div class="flex gap-2"><button id="btnCoordWeekPrev" class="p-2 bg-white/10 rounded-xl hover:bg-white/20"><i data-lucide="chevron-left" style="width:16px;height:16px;"></i></button><button id="btnCoordWeekNext" class="p-2 bg-white/10 rounded-xl hover:bg-white/20"><i data-lucide="chevron-right" style="width:16px;height:16px;"></i></button></div></div><div class="overflow-x-auto no-scrollbar"><table class="w-full text-[10px] text-left"><thead class="bg-slate-50 border-b border-slate-100"><tr><th class="p-4 text-[8px] font-black text-slate-400 uppercase w-16 text-center">HEURE</th>${days.map(d => `<th class="p-4 text-[8px] font-black text-slate-400 uppercase">${d}</th>`).join("")}</tr></thead><tbody class="divide-y divide-slate-50 font-bold">${hours.map(h => `<tr><td class="p-4 font-black text-slate-300 text-center">${h}</td>${days.map(d => {
    const list = state.availabilityMatrix[`${d}|${h}`] || [];
    return `<td class="p-2 align-top"><div class="flex flex-wrap gap-1">${list.length ? list.map(name => `<span class="px-2 py-0.5 bg-emerald-50 text-emerald-700 rounded-md text-[7px] font-black uppercase tracking-widest border border-emerald-100">${escapeHtml(name)}</span>`).join("") : `<span class="text-slate-200">—</span>`}</div></td>`;
  }).join("")}</tr>`).join("")}</tbody></table></div></div>`;
}

function AuditViewHTML() {
  return `<div class="bg-white rounded-[2rem] shadow-xl p-8 border border-slate-100 animate-in text-left"><h3 class="text-sm font-black mb-6 uppercase tracking-widest text-emerald-900 leading-none">Journal d'Audit & Triggers v4.8</h3><div class="space-y-1.5 max-h-[300px] overflow-y-auto no-scrollbar pr-2">${state.systemLogs.map(log => `<div class="flex justify-between items-center p-3 bg-slate-50 rounded-xl text-[9px] font-bold border-l-4 border-slate-900 shadow-sm transition-all hover:bg-slate-100"><span class="text-slate-400 font-mono tracking-tighter">${log.time}</span><span class="flex-1 px-4 truncate uppercase tracking-tighter opacity-70">${log.event}</span><span class="text-emerald-600 uppercase tracking-widest font-black">${log.status}</span></div>`).join("")}</div></div>`;
}

function CoordinationDashboardHTML() {
  const missions = state.missions;
  const attente = missions.filter(m => m.statut === "ATTENTE").length;
  const validees = missions.filter(m => m.statut === "VALIDÉ").length;

  // Calcul du nombre de bénévoles actifs (uniques dans la matrice)
  const activeVolunteers = new Set();
  Object.values(state.availabilityMatrix).forEach(names => names.forEach(n => activeVolunteers.add(n)));
  const volCount = activeVolunteers.size || 0;
  
  const journalHTML = `<div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-100 animate-in text-left"><table class="w-full text-left text-[10px]"><thead class="bg-slate-50 text-slate-400 font-black uppercase text-[7px] tracking-widest border-b border-slate-100"><tr><th class="p-4">RDV / Heure</th><th class="p-4">Organisme</th><th class="p-4">Statut</th><th class="p-4 text-right">Actions</th></tr></thead><tbody class="font-bold">${missions.filter(m => !upperTrim(m.statut).startsWith("ARCHIV")).map(m => `<tr class="border-t border-slate-50 hover:bg-slate-50/50 transition-colors"><td class="p-4 font-black">${m.date}<br/><span class="text-emerald-600 text-[8px] tracking-widest">${m.heure}</span></td><td class="p-4 uppercase leading-tight tracking-tighter">${m.structure}<br/><span class="text-slate-300 text-[7px] font-black">${m.typeMission}</span></td><td class="p-4"><span class="px-2.5 py-0.5 rounded-md text-[7px] font-black tracking-widest ${m.statut === "ATTENTE" ? "bg-amber-100 text-amber-600" : "bg-emerald-100 text-emerald-600 shadow-sm"}">${m.statut}</span></td><td class="p-4 text-right"><button data-open-mission="${m.code}" class="p-2 text-slate-300 hover:text-emerald-600 flex items-center justify-center ml-auto"><i data-lucide="edit-3" style="width:16px;height:16px;"></i></button></td></tr>`).join("")}</tbody></table></div>`;

  const tabsHTML = `<div class="flex gap-2 overflow-x-auto pb-1 no-scrollbar">${[
    {id:'journal', label:'Dossiers', icon:'clipboard-list'},
    {id:'planning', label:'Calendrier', icon:'calendar'},
    {id:'benevoles', label:'Planning Bénévoles', icon:'users'},
    {id:'archives', label:'Archives', icon:'archive'},
    {id:'audit', label:'Audit Flux', icon:'activity'}
  ].map(t => `<button data-coord-tab="${t.id}" class="px-5 py-2.5 rounded-xl font-black text-[9px] uppercase tracking-widest flex items-center gap-2 transition-all ${state.coordTab === t.id ? "bg-emerald-600 text-white shadow-xl scale-105" : "bg-white text-slate-400 border border-slate-200 hover:bg-slate-50"}"><i data-lucide="${t.icon}" style="width:14px;height:14px;"></i> ${t.label}</button>`).join("")}</div>`;

  let bodyHTML = journalHTML;
  if (state.coordTab === "planning") bodyHTML = CoordMonthCalendarHTML();
  if (state.coordTab === "benevoles") bodyHTML = CoordVolunteerWeekHTML();
  if (state.coordTab === "audit") bodyHTML = AuditViewHTML();
  if (state.coordTab === "archives") bodyHTML = `<div class="p-20 text-center bg-white rounded-3xl border border-dashed border-slate-100 text-slate-300 font-black uppercase tracking-widest text-[10px]">Archives v4.8</div>`;

  return `<div class="space-y-4 animate-in text-left"><div class="grid grid-cols-4 gap-3">${[
    {l:'Attente', v:attente, c:'text-amber-600'},
    {l:'Validées', v:validees, c:'text-emerald-600'},
    {l:'En Cours', v:missions.filter(m => m.volunteerName).length, c:'text-blue-600'},
    {l:'Bénévoles', v:volCount, c:'text-slate-900'}
  ].map(s => `<div class="bg-white p-4 rounded-2xl shadow-lg border border-slate-50 text-center"><p class="text-[7px] font-black text-slate-300 uppercase tracking-[0.2em] mb-1.5 leading-none">${s.l}</p><p class="text-2xl font-black ${s.c} tracking-tighter leading-none">${s.v}</p></div>`).join("")}</div>${tabsHTML}${bodyHTML}</div>`;
}

function MainViewHTML() {
  if (state.view === "hub") return HubHTML();
  if (state.view === "partner") return PartnerModuleHTML();
  if (state.view === "volunteer" && state.authRole === "BENE") return VolunteerDashboardHTML();
  if (state.view === "coord" && state.authRole === "COORD") return CoordinationDashboardHTML();
  return HubHTML();
}

/** * LOGIQUE ACTIONS & RENDER
 */
async function handleLogin(token) {
  state.loading = true; render();
  try {
    const res = await fetchWithRetry(`${API_URL}?action=validateToken&token=${encodeURIComponent(token)}`);
    if (res?.ok && res.profile) {
      state.user = { 
        name: res.profile.name || res.profile.nom, 
        token, 
        role: upperTrim(res.role || res.profile.role).includes("COORD") ? "COORD" : "BENE", 
        secteur: res.profile.secteur || "Centre" 
      };
      state.authRole = state.user.role;
      if (state.authRole === "COORD") await fetchAvailabilityMatrix();
      goTo(state.authRole === "COORD" ? "coord" : "volunteer");
    } else { alert("Token invalide."); }
  } catch (err) { state.error = "Serveur indisponible."; } finally { state.loading = false; render(); }
}

async function handleAction(payload) {
  state.loading = true; render();
  try {
    const res = await fetchWithRetry(API_URL, {
      method: "POST",
      body: JSON.stringify({ ...payload, token: state.user?.token })
    });
    if (res?.ok) {
      await fetchMissions();
      if (state.authRole === "COORD") await fetchAvailabilityMatrix();
      render();
      return res;
    }
    throw new Error(res?.error || "Opération refusée");
  } catch (err) {
    state.error = err.message;
    render();
  } finally {
    state.loading = false; render();
  }
}

async function fetchAvailabilityMatrix() {
  try {
    const res = await fetchWithRetry(`${API_URL}?action=getAvailabilityMatrix`);
    if (res?.ok && res.matrix) { state.availabilityMatrix = res.matrix; state.availabilityLastSync = new Date().toISOString(); }
  } catch (e) {}
}

async function fetchMissions() {
  try {
    const res = await fetchWithRetry(`${API_URL}?action=listMissions`);
    if (res?.ok) state.missions = (Array.isArray(res.missions) ? res.missions : []).map(normalizeMission);
  } catch (e) { state.missions = []; }
}

function startCoordPolling() {
  stopCoordPolling();
  state.coordPollingTimer = setInterval(() => { if (state.view === "coord") { fetchMissions(); fetchAvailabilityMatrix(); render(); } }, 20000);
}
function stopCoordPolling() { if (state.coordPollingTimer) clearInterval(state.coordPollingTimer); }

function render() {
  const modalHTML = state.selectedMission ? `
    <div class="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-slate-900/70 backdrop-blur-md">
      <div class="bg-white w-full max-w-sm rounded-[3rem] shadow-2xl overflow-hidden animate-in">
        <div class="bg-emerald-900 p-8 text-white text-left">
          <div class="flex justify-between items-start mb-4"><p class="text-[8px] font-black uppercase opacity-60">Fiche Mission</p><button id="btnCloseMissionModal" class="text-white/40"><i data-lucide="x-circle"></i></button></div>
          <h3 class="text-2xl font-black uppercase tracking-tighter leading-none">${escapeHtml(state.selectedMission.structure)}</h3>
        </div>
        <div class="p-8 space-y-4 text-left">
          <p class="text-[10px] font-bold">DATE: ${state.selectedMission.date} à ${state.selectedMission.heure}</p>
          <div class="flex gap-2">
            <button id="btnModalValidate" class="flex-1 bg-emerald-600 text-white py-4 rounded-2xl font-black uppercase text-[10px]">Valider Mission</button>
            <button id="btnModalArchive" class="flex-1 bg-slate-900 text-white py-4 rounded-2xl font-black uppercase text-[10px]">Archiver</button>
          </div>
        </div>
      </div>
    </div>` : '';

  $app.innerHTML = `<div data-uikey="${state.uiKey}">${NavbarHTML()}<main class="max-w-6xl mx-auto px-4 py-6 text-left">${MainViewHTML()}</main>${AuthModalHTML()}${modalHTML}${FooterHTML()}${state.loading ? LoaderHTML() : ``}</div>`;
  try { lucide.createIcons(); } catch(e) {}
  bindEvents();
}

function bindEvents() {
  const navHome = document.getElementById("navHome"); if (navHome) navHome.onclick = () => goTo("hub");
  const btnLogout = document.getElementById("btnLogout"); if (btnLogout) btnLogout.onclick = () => { state.user = null; goTo("hub"); };
  
  document.querySelectorAll("[data-hub-action]").forEach(el => { 
    el.onclick = () => { 
      const act = el.getAttribute("data-hub-action"); 
      if (act === "partner") { state.partnerSubmitted = false; goTo("partner"); } 
      else { state.isAuthModalOpen = true; render(); } 
    }; 
  });

  const authForm = document.getElementById("authForm"); if (authForm) authForm.onsubmit = (e) => { e.preventDefault(); handleLogin(document.getElementById("tokenInput").value); };
  const btnAuthCancel = document.getElementById("btnAuthCancel"); if (btnAuthCancel) btnAuthCancel.onclick = () => { state.isAuthModalOpen = false; render(); };
  
  // Navigation coordination
  document.querySelectorAll("[data-coord-tab]").forEach(btn => { btn.onclick = () => { state.coordTab = btn.getAttribute("data-coord-tab"); render(); }; });
  const btnCalPrev = document.getElementById("btnCalPrev"); if (btnCalPrev) btnCalPrev.onclick = () => { state.calendarBaseDate = new Date(state.calendarBaseDate.getFullYear(), state.calendarBaseDate.getMonth() - 1, 1); render(); };
  const btnCalNext = document.getElementById("btnCalNext"); if (btnCalNext) btnCalNext.onclick = () => { state.calendarBaseDate = new Date(state.calendarBaseDate.getFullYear(), state.calendarBaseDate.getMonth() + 1, 1); render(); };
  const btnCoordWeekPrev = document.getElementById("btnCoordWeekPrev"); if (btnCoordWeekPrev) btnCoordWeekPrev.onclick = () => { state.coordWeekDate.setDate(state.coordWeekDate.getDate() - 7); render(); };
  const btnCoordWeekNext = document.getElementById("btnCoordWeekNext"); if (btnCoordWeekNext) btnCoordWeekNext.onclick = () => { state.coordWeekDate.setDate(state.coordWeekDate.getDate() + 7); render(); };

  // Missions & Modale
  document.querySelectorAll("[data-open-mission]").forEach(btn => { 
    btn.onclick = () => { 
      const code = btn.getAttribute("data-open-mission");
      state.selectedMission = state.missions.find(m => String(m.code) === String(code)); 
      render(); 
    }; 
  });
  const btnCloseMissionModal = document.getElementById("btnCloseMissionModal"); if (btnCloseMissionModal) btnCloseMissionModal.onclick = () => { state.selectedMission = null; render(); };
  const btnModalValidate = document.getElementById("btnModalValidate"); if (btnModalValidate) btnModalValidate.onclick = async () => { await handleAction({ action: "updateStatus", code: state.selectedMission.code, status: "VALIDÉ" }); state.selectedMission = null; render(); };
  const btnModalArchive = document.getElementById("btnModalArchive"); if (btnModalArchive) btnModalArchive.onclick = async () => { await handleAction({ action: "updateStatus", code: state.selectedMission.code, status: "ARCHIVÉ" }); state.selectedMission = null; render(); };

  // Partner
  const btnBackHubFromPartner = document.getElementById("btnBackHubFromPartner"); if (btnBackHubFromPartner) btnBackHubFromPartner.onclick = () => goTo("hub");
  const btnPartnerBackHub = document.getElementById("btnPartnerBackHub"); if (btnPartnerBackHub) btnPartnerBackHub.onclick = () => goTo("hub");
  const partnerForm = document.getElementById("partnerForm"); if (partnerForm) {
    partnerForm.onsubmit = async (e) => {
      e.preventDefault();
      const fd = new FormData(partnerForm);
      const res = await handleAction({ action: "createMission", ...Object.fromEntries(fd.entries()) });
      if (res?.ok) { state.partnerSubmitted = true; render(); }
    };
  }

  // SÉLECTION ZONE BÉNÉVOLE
  const volunteerSecteurSelect = document.getElementById("volunteerSecteurSelect");
  if (volunteerSecteurSelect) {
    volunteerSecteurSelect.onchange = () => {
      if (state.user) {
        state.user.secteur = volunteerSecteurSelect.value;
        render(); // Mise à jour UI locale
      }
    };
  }

  // Volunteer Navigation & Planning
  const btnWeekPrev = document.getElementById("btnWeekPrev"); if (btnWeekPrev) btnWeekPrev.onclick = () => { state.volunteerCurrentDate.setDate(state.volunteerCurrentDate.getDate() - 7); render(); };
  const btnWeekNext = document.getElementById("btnWeekNext"); if (btnWeekNext) btnWeekNext.onclick = () => { state.volunteerCurrentDate.setDate(state.volunteerCurrentDate.getDate() + 7); render(); };
  
  const btnSavePlanning = document.getElementById("btnSavePlanning"); 
  if (btnSavePlanning) {
    btnSavePlanning.onclick = async () => {
      // Transformation des slots sélectionnés en pattern simple (Jour|Heure)
      const pattern = Array.from(state.selectedSlots).map(k => {
        const parts = k.split("-");
        return `${parts[parts.length - 2]}|${parts[parts.length - 1]}`;
      });
      
      const res = await handleAction({ 
        action: "saveAvailabilityPattern", 
        pattern: pattern,
        secteur: state.user.secteur 
      });

      if (res && res.ok) {
        await fetchAvailabilityMatrix(); // Recharger la matrice globale
        render();
      }
    };
  }

  document.querySelectorAll("[data-take-mission]").forEach(btn => {
    btn.onclick = () => handleAction({ action: "takeMission", code: btn.getAttribute("data-take-mission") });
  });

  // Disponibilités (Clic sur cases)
  document.querySelectorAll("[data-slot-key]").forEach(cell => { cell.onclick = () => { const k = cell.getAttribute("data-slot-key"); if (state.selectedSlots.has(k)) state.selectedSlots.delete(k); else state.selectedSlots.add(k); render(); }; });
}

(async function init() {
  const bypass = setTimeout(() => { if (state.loading) { state.loading = false; state.error = "Mode secours activé."; render(); } }, TIMEOUT_BYPASS);
  await fetchMissions();
  clearTimeout(bypass);
  state.loading = false;
  render();
})();
  </script>
</body>
</html>
